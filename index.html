<!doctype html>
<html lang="pt-BR" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistema de Libera√ß√£o 04B1 - Procedimento Interativo</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
        body { box-sizing: border-box; }
        .step-card { transition: all 0.3s ease; }
        .step-card:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .execute-btn { transition: all 0.2s ease; }
        .execute-btn:hover:not(:disabled) { transform: scale(1.05); }
        .executing { animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        .status-indicator { transition: all 0.3s ease; }
        .completed { background: linear-gradient(135deg, #10b981, #059669); }
        .executing-status { background: linear-gradient(135deg, #f59e0b, #d97706); }
        .pending { background: linear-gradient(135deg, #6b7280, #4b5563); }
        .disabled { background: linear-gradient(135deg, #e5e7eb, #d1d5db); }
        .skipped { background: linear-gradient(135deg, #fbbf24, #f59e0b); }
        .deferred { background: linear-gradient(135deg, #a855f7, #9333ea); }
        .progress-bar { transition: width 0.5s ease; }
        .step-number { background: linear-gradient(135deg, #3b82f6, #1d4ed8); }
        .paused { opacity: 0.3; pointer-events: none; filter: grayscale(50%); transition: all 0.3s ease; }
        .pause-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.1); z-index: 10; pointer-events: none; opacity: 0; transition: opacity 0.3s ease; }
        .pause-overlay.active { opacity: 1; }
    </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="/_sdk/element_sdk.js" type="text/javascript"></script>
 </head>
 <body class="h-full bg-gradient-to-br from-blue-50 to-indigo-100 font-sans">
  <!-- Pause Overlay -->
  <div id="pauseOverlay" class="pause-overlay"></div>
  <div class="min-h-full p-6">
   <!-- Header -->
   <div class="max-w-6xl mx-auto mb-8">
    <div class="bg-white rounded-2xl shadow-lg p-6 border border-gray-200">
     <!-- REMOVIDAS abas de navega√ß√£o -->
     <div class="flex items-center justify-between mb-4">
      <div>
       <h1 class="text-3xl font-bold text-gray-800 mb-2" id="pageTitle">‚ö° Procedimento de Libera√ß√£o 04B1</h1>
       <p class="text-gray-600" id="pageDescription">Procedimento de libera√ß√£o el√©trica - Execu√ß√£o sequencial</p>
      </div>
      <div class="text-right">
       <div class="text-2xl font-bold text-indigo-600" id="progressText">0/14</div>
       <div class="text-sm text-gray-500">Etapas conclu√≠das</div>
      </div>
     </div>
     <div class="w-full bg-gray-200 rounded-full h-3 mb-4">
      <div class="progress-bar bg-gradient-to-r from-red-500 to-red-600 h-3 rounded-full" style="width: 0%" id="progressBar"></div>
     </div>
     <div class="flex items-center space-x-6">
      <div class="flex items-center"><div class="w-3 h-3 bg-gray-500 rounded-full mr-2"></div><span class="text-sm text-gray-600">Pendente</span></div>
      <div class="flex items-center"><div class="w-3 h-3 bg-amber-500 rounded-full mr-2"></div><span class="text-sm text-gray-600">Executando</span></div>
      <div class="flex items-center"><div class="w-3 h-3 bg-green-500 rounded-full mr-2"></div><span class="text-sm text-gray-600">Conclu√≠do</span></div>
      <div class="flex items-center"><div class="w-3 h-3 bg-yellow-500 rounded-full mr-2"></div><span class="text-sm text-gray-600">Pulado</span></div>
      <div class="flex items-center"><div class="w-3 h-3 bg-purple-500 rounded-full mr-2"></div><span class="text-sm text-gray-600">Adiado</span></div>
      <div class="flex items-center"><div class="w-3 h-3 bg-gray-300 rounded-full mr-2"></div><span class="text-sm text-gray-600">Bloqueado</span></div>
     </div>
    </div>
   </div>
   <!-- Information Header -->
   <div class="max-w-6xl mx-auto mb-8" id="infoHeader">
    <!-- Content will be populated by JavaScript -->
   </div>
   <!-- Steps Grid -->
   <div class="max-w-6xl mx-auto">
    <div class="grid grid-cols-1 gap-6" id="stepsGrid">
     <!-- Steps will be populated by JavaScript -->
    </div>
   </div>
   <!-- Control Panel -->
   <div class="max-w-6xl mx-auto mt-8">
    <div class="bg-white rounded-2xl shadow-lg p-6 border border-gray-200">
     <div class="flex items-center justify-between mb-4">
      <h2 class="text-xl font-bold text-gray-800">üéõÔ∏è Painel de Controle</h2>
      <div class="flex space-x-3">
       <button onclick="resetProcedure()" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg font-medium transition-colors">üîÑ Reiniciar</button>
       <button onclick="togglePause()" id="pauseBtn" class="px-4 py-2 bg-orange-600 hover:bg-orange-700 text-white rounded-lg font-medium transition-colors">‚è∏Ô∏è Pausar</button>
       <button onclick="skipCurrentStep()" id="skipBtn" class="px-4 py-2 bg-yellow-600 hover:bg-yellow-700 text-white rounded-lg font-medium transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled>‚è≠Ô∏è Pular Item</button>
       <button onclick="deferCurrentStep()" id="deferBtn" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg font-medium transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled>‚è∞ Executar Depois</button>
       <button onclick="executeNext()" id="nextBtn" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-medium transition-colors">‚ñ∂Ô∏è Pr√≥xima Etapa</button>
       <button onclick="finalizeProcedure()" id="finishBtn" class="px-4 py-2 bg-green-700 hover:bg-green-800 text-white rounded-lg font-medium transition-colors">‚úîÔ∏è CONCLUIR</button>
      </div>
     </div>
    </div>
   </div>
   <!-- Execution Log -->
   <div class="max-w-6xl mx-auto mt-8">
    <div class="bg-white rounded-2xl shadow-lg p-6 border border-gray-200">
     <div class="flex items-center justify-between mb-4">
      <h2 class="text-xl font-bold text-gray-800">üìã Log de Execu√ß√£o</h2>
      <button onclick="exportLogToPDF()" id="exportBtn" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg font-medium transition-colors flex items-center space-x-2 disabled:opacity-50 disabled:cursor-not-allowed" disabled><span>üìÑ</span><span>Exportar PDF</span></button>
     </div>
     <div id="executionLog" class="space-y-2 max-h-60 overflow-y-auto"><p class="text-gray-500 italic">Aguardando in√≠cio do procedimento...</p></div>
    </div>
   </div>
   <!-- Signature Section -->
   <div class="max-w-6xl mx-auto mt-8">
    <div class="bg-white rounded-2xl shadow-lg p-6 border border-gray-200">
     <h2 class="text-xl font-bold text-gray-800 mb-6">‚úçÔ∏è Assinatura e Data</h2>
     <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
      <div><label class="block text-sm font-semibold text-gray-600 mb-2">Assinatura do Respons√°vel:</label><div class="border-b-2 border-gray-300 pb-2 mb-4" style="min-height: 40px;"></div></div>
      <div><label class="block text-sm font-semibold text-gray-600 mb-2">Data de Execu√ß√£o:</label><div class="border-b-2 border-gray-300 pb-2 mb-4 text-center" style="min-height: 40px;"><span class="text-gray-400">___/___/______</span></div></div>
     </div>
    </div>
   </div>
   <!-- Footer -->
   <footer class="max-w-6xl mx-auto mt-8">
    <div class="bg-gray-50 rounded-2xl shadow-lg p-6 border border-gray-200">
     <div class="flex items-center justify-between text-sm text-gray-600">
      <div class="flex items-center space-x-4"><span class="font-semibold">RTM-CTM-04B1</span><span>Ed.: 2</span><span>28/09/2020</span></div>
      <div class="flex items-center space-x-4"><span>Elabora√ß√£o: Maria Amad√©lia Lopes</span><span class="font-semibold" id="pageNumber">1/2</span></div>
     </div>
    </div>
   </footer>
  </div>
  <script>
    async function callExecute(step, index) {
      try { const res = await fetch('/api/execute', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ step, index }) }); return await res.json(); } catch (e) { return { ok: false, error: String(e) }; }
    }

    const steps = [
      { id:1, number:"1.1", responsible:"CTM", action:"Receber do respons√°vel solicita√ß√£o libera√ß√£o 04B1", icon:"üì•", duration:2000, phase:"LIBERA√á√ÉO" },
      { id:2, number:"1.2", responsible:"CTM", action:"Solicitar COOS libera√ß√£o 04B1", icon:"üìû", duration:2500, phase:"LIBERA√á√ÉO" },
      { id:3, number:"1.3", responsible:"COOS/CTM", action:"Bloquear comando el√©trico 34F9-1", icon:"üîí", duration:3000, phase:"LIBERA√á√ÉO" },
      { id:4, number:"1.4", responsible:"COOS", action:"Solicitar COSR-NE libera√ß√£o 04B1/CTM", icon:"üìã", duration:2500, phase:"LIBERA√á√ÉO" },
      { id:5, number:"1.5", responsible:"COSR-NE", action:"Autorizar COOS libera√ß√£o 04B1/CTM", icon:"‚úÖ", duration:2000, phase:"LIBERA√á√ÉO" },
      { id:6, number:"1.6", responsible:"COOS", action:"Autorizar CTM libera√ß√£o 04B1", icon:"üîì", duration:2000, phase:"LIBERA√á√ÉO" },
      { id:7, number:"1.7", responsible:"CTM", action:"Confirmar 14D1 fechado", icon:"üîç", duration:2500, phase:"LIBERA√á√ÉO" },
      { id:8, number:"1.8", responsible:"CTM", action:"Fechar 34C3-2 e 34W1-2", icon:"üîß", duration:3500, phase:"LIBERA√á√ÉO", multiIndex:[0,1] },
      { id:9, number:"1.9", responsible:"CTM", action:"Abrir 34W1-1 e 34C3-1", icon:"üîß", duration:3500, phase:"LIBERA√á√ÉO", multiIndex:[0,1] },
      { id:10, number:"1.10", responsible:"CTM", action:"Abrir 14D1", icon:"üîì", duration:3000, phase:"LIBERA√á√ÉO" },
      { id:11, number:"1.11", responsible:"CTM", action:"Abrir 34D1-1", icon:"üîì", duration:3000, phase:"LIBERA√á√ÉO" },
      { id:12, number:"1.12", responsible:"CTM", action:"Bloquear comando el√©trico 34D1-1, 34C3-1 e 34W1-1", icon:"üîí", duration:4000, phase:"LIBERA√á√ÉO" },
      { id:13, number:"1.13", responsible:"CTM", action:"Entregar 04B1 isolado ao respons√°vel", icon:"ü§ù", duration:2500, phase:"LIBERA√á√ÉO" },
      { id:14, number:"1.14", responsible:"CTM", action:"Informar COOS conclus√£o libera√ß√£o 04B1", icon:"üì¢", duration:2000, phase:"LIBERA√á√ÉO" },
      { id:15, number:"2.1", responsible:"CTM", action:"Receber do respons√°vel 04B1 livre para opera√ß√£o", icon:"üì•", duration:2000, phase:"NORMALIZA√á√ÉO" },
      { id:16, number:"2.2", responsible:"CTM", action:"Confirmar aus√™ncia de aterramento tempor√°rio", icon:"üîç", duration:2500, phase:"NORMALIZA√á√ÉO" },
      { id:17, number:"2.3", responsible:"CTM", action:"Solicitar COOS normaliza√ß√£o 04B1", icon:"üìû", duration:2500, phase:"NORMALIZA√á√ÉO" },
      { id:18, number:"2.4", responsible:"COOS", action:"Autorizar CTM iniciar normaliza√ß√£o 04B1", icon:"‚úÖ", duration:2000, phase:"NORMALIZA√á√ÉO" },
      { id:19, number:"2.5", responsible:"CTM", action:"Desbloquear comando el√©trico 34W1-1, 34C3-1 e 34D1-1", icon:"üîì", duration:4000, phase:"NORMALIZA√á√ÉO" },
      { id:20, number:"2.6", responsible:"CTM", action:"Fechar 34D1-1", icon:"üîß", duration:3000, phase:"NORMALIZA√á√ÉO" },
      { id:21, number:"2.7", responsible:"CTM", action:"Informar COOS conclus√£o manobras", icon:"üì¢", duration:2000, phase:"NORMALIZA√á√ÉO" },
      { id:22, number:"2.8", responsible:"COOS", action:"Informar COSR-NE disponibilidade 04B1/CTM", icon:"üìã", duration:2500, phase:"NORMALIZA√á√ÉO" },
      { id:23, number:"2.9", responsible:"COSR-NE", action:"Autorizar COOS normaliza√ß√£o 04B1/CTM", icon:"‚úÖ", duration:2000, phase:"NORMALIZA√á√ÉO" },
      { id:24, number:"2.10", responsible:"COOS", action:"Autorizar CTM normaliza√ß√£o 04B1", icon:"üîì", duration:2000, phase:"NORMALIZA√á√ÉO" },
      { id:25, number:"2.11", responsible:"CTM", action:"Fechar 14D1", icon:"üîß", duration:3000, phase:"NORMALIZA√á√ÉO" },
      { id:26, number:"2.12", responsible:"CTM", action:"Fechar 34W1-1 e 34C3-1", icon:"üîß", duration:3500, phase:"NORMALIZA√á√ÉO", multiIndex:[0,1] },
      { id:27, number:"2.13", responsible:"CTM", action:"Abrir 34C3-2 e 34W1-2", icon:"üîß", duration:3500, phase:"NORMALIZA√á√ÉO", multiIndex:[0,1] },
      { id:28, number:"2.14", responsible:"CTM", action:"Desbloquear comando el√©trico 34F9-1", icon:"üîì", duration:3000, phase:"NORMALIZA√á√ÉO" },
      { id:29, number:"2.15", responsible:"CTM", action:"Informar COOS conclus√£o normaliza√ß√£o 04B1", icon:"üì¢", duration:2000, phase:"NORMALIZA√á√ÉO" }
    ];

    let stepStates = {}; let currentStep = 1; let completedSteps = 0; let currentPage = 'liberation'; let isPaused = false; let liberationStarted = false; let normalizationStarted = false; let normalizationAccessAuthorized = false;
    steps.forEach(step => { stepStates[step.id] = 'disabled'; });

    async function execMappedCommands(stepNumber, multiIndex) {
      try { const res = await fetch(`/api/commands/${encodeURIComponent(stepNumber)}`); const js = await res.json(); if (!js.ok) { return { ok: true, executed: [], note: 'Sem comandos mapeados' }; } } catch {}
      const payload = { step: stepNumber }; if (typeof multiIndex === 'number') payload.index = multiIndex; return await callExecute(payload.step, payload.index);
    }

    function switchPage(page) {
      currentPage = page;
      const pageTitle = document.getElementById('pageTitle');
      const pageDescription = document.getElementById('pageDescription');
      const progressBar = document.getElementById('progressBar');
      const pageNumber = document.getElementById('pageNumber');
      const nextBtn = document.getElementById('nextBtn');
      if (page === 'liberation') {
        pageTitle.textContent = '‚ö° Procedimento de Libera√ß√£o 04B1';
        pageDescription.textContent = 'Procedimento de libera√ß√£o el√©trica - Execu√ß√£o sequencial';
        progressBar.className = 'progress-bar bg-gradient-to-r from-red-500 to-red-600 h-3 rounded-full';
        if (pageNumber) pageNumber.textContent = '1/2';
        if (nextBtn) { nextBtn.disabled = false; nextBtn.className = 'px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-medium transition-colors'; nextBtn.textContent = '‚ñ∂Ô∏è Pr√≥xima Etapa'; }
      } else {
        pageTitle.textContent = '‚ö° Procedimento de Normaliza√ß√£o 04B1';
        pageDescription.textContent = 'Procedimento de normaliza√ß√£o el√©trica - Execu√ß√£o sequencial';
        progressBar.className = 'progress-bar bg-gradient-to-r from-green-500 to-green-600 h-3 rounded-full';
        if (pageNumber) pageNumber.textContent = '2/2';
        if (nextBtn) { nextBtn.disabled = true; nextBtn.className = 'px-4 py-2 bg-gray-400 text-white rounded-lg font-medium cursor-not-allowed opacity-50'; nextBtn.textContent = '‚ñ∂Ô∏è Pr√≥xima Etapa'; }
      }
      renderSteps();
    }

    function getResponsibleColor(r){const c={'CTM':'from-blue-500 to-blue-600','COOS':'from-green-500 to-green-600','COSR-NE':'from-purple-500 to-purple-600','COOS/CTM':'from-orange-500 to-orange-600'};return c[r]||'from-gray-500 to-gray-600';}

    function renderInfoHeader(){ const infoHeader=document.getElementById('infoHeader'); if(currentPage==='liberation'){ const startBtnHtml = liberationStarted?`<button id="startBtn" disabled class="px-8 py-4 bg-gradient-to-r from-green-600 to-green-700 text-white font-bold text-lg rounded-xl shadow-lg disabled:opacity-50 disabled:cursor-not-allowed">‚úÖ MANOBRA INICIADA</button>`:`<button onclick="startProcedure()" id="startBtn" class="px-8 py-4 bg-gradient-to-r from-red-600 to-red-700 hover:from-red-700 hover:to-red-800 text-white font-bold text-lg rounded-xl shadow-lg transform transition-all duration-200 hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none">üöÄ INICIAR MANOBRA</button>`; infoHeader.innerHTML = `<div class="bg-white rounded-2xl shadow-lg p-6 border border-gray-200"><div class="grid grid-cols-1 lg:grid-cols-2 gap-6"><div class="space-y-4"><div class="grid grid-cols-2 gap-4"><div><h3 class="text-sm font-semibold text-gray-600 mb-1">ORIGEM:</h3><p class="text-lg font-bold text-gray-800">CROL</p></div><div><h3 class="text-sm font-semibold text-gray-600 mb-1">EQUIPAMENTO:</h3><p class="text-lg font-bold text-gray-800">04B1-CTM</p></div></div><div class="grid grid-cols-2 gap-4"><div><h3 class="text-sm font-semibold text-gray-600 mb-1">PER√çODO:</h3><p class="text-base text-gray-700">-</p></div><div><h3 class="text-sm font-semibold text-gray-600 mb-1">REFER√äNCIA:</h3><p class="text-base text-gray-700">-</p></div></div><div><h3 class="text-sm font-semibold text-gray-600 mb-2">RESPONS√ÅVEIS:</h3><p class="text-base text-gray-700">-</p></div><div><h3 class="text-sm font-semibold text-gray-600 mb-2">MOTIVO DA REVIS√ÉO:</h3><ul class="text-base text-gray-700 space-y-1"><li>‚Ä¢ Seccionamento da LT 04F8 PFE/CTM em SE LAC.</li><li>‚Ä¢ Substitui√ß√£o de CROL para COOS.</li></ul></div></div><div class="space-y-4"><div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4"><h3 class="text-sm font-semibold text-yellow-800 mb-2 flex items-center">‚ö†Ô∏è ATEN√á√ÉO</h3><p class="text-base text-yellow-700">Procedimento cr√≠tico de seguran√ßa el√©trica</p></div><div class="bg-blue-50 border border-blue-200 rounded-lg p-4"><h3 class="text-sm font-semibold text-blue-800 mb-3 flex items-center">‚öôÔ∏è CONFIGURA√á√ÉO</h3><ul class="text-sm text-blue-700 space-y-2"><li>‚Ä¢ <strong>14D1</strong> fechado com chaves associadas fechadas e todas as chaves by-pass 230 kV abertas.</li><li>‚Ä¢ <strong>04B1</strong> e <strong>04B2</strong> acoplados atrav√©s do <strong>14D1</strong>.</li><li>‚Ä¢ <strong>14C3</strong> e <strong>14W1</strong> conectados ao <strong>04B1</strong>.</li><li>‚Ä¢ <strong>14F9</strong> conectado ao <strong>04B2</strong>.</li></ul></div></div></div><div class="mt-6 text-center">${startBtnHtml}</div></div>`; } else { if(!normalizationAccessAuthorized){ infoHeader.innerHTML = `<div class=\"bg-white rounded-2xl shadow-lg p-6 border border-gray-200\"><div class=\"bg-red-50 border-2 border-red-300 rounded-lg p-6\"><div class=\"text-center mb-6\"><div class=\"text-6xl mb-4\">üö´</div><h3 class=\"text-2xl font-bold text-red-800 mb-4\">ACESSO RESTRITO √Ä NORMALIZA√á√ÉO</h3></div><div class=\"bg-white border border-red-200 rounded-lg p-4 mb-6\"><h4 class=\"text-lg font-bold text-red-700 mb-3 flex items-center\">‚ö†Ô∏è Acesso N√£o Autorizado</h4><p class=\"text-red-700 mb-4\">A fase de <strong>Normaliza√ß√£o</strong> s√≥ pode ser acessada atrav√©s do bot√£o <strong>\"Pr√≥xima Etapa\"</strong> no painel de controle, ap√≥s a conclus√£o adequada da fase de Libera√ß√£o.</p><p class=\"text-red-600 font-semibold\">üîí Todos os controles est√£o bloqueados nesta visualiza√ß√£o.</p></div><div class=\"bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6\"><h4 class=\"text-lg font-bold text-blue-800 mb-3 flex items-center\">üìã Como Acessar Corretamente:</h4><ol class=\"text-blue-700 space-y-2\"><li><strong>1.</strong> Complete as etapas de libera√ß√£o</li><li><strong>2.</strong> Use o bot√£o <strong>\"Pr√≥xima Etapa\"</strong> no painel de controle</li><li><strong>3.</strong> A normaliza√ß√£o ser√° desbloqueada automaticamente</li></ol></div></div></div>`; } else { const startNormalizationBtnHtml = normalizationStarted?`<button id="startNormalizationBtn" disabled class="px-8 py-4 bg-gradient-to-r from-blue-600 to-blue-700 text-white font-bold text-lg rounded-xl shadow-lg disabled:opacity-50 disabled:cursor-not-allowed">‚úÖ NORMALIZA√á√ÉO INICIADA</button>`:`<button onclick=\"startNormalization()\" id=\"startNormalizationBtn\" class=\"px-8 py-4 bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 text-white font-bold text-lg rounded-xl shadow-lg transform transition-all duration-200 hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none\">üîì INICIAR NORMALIZA√á√ÉO</button>`; infoHeader.innerHTML = `<div class="bg-white rounded-2xl shadow-lg p-6 border border-gray-200"><div class="bg-green-50 border border-green-200 rounded-lg p-6"><h3 class="text-lg font-semibold text-green-800 mb-4 flex items-center">üîì PROCEDIMENTO DE NORMALIZA√á√ÉO</h3><p class="text-base text-green-700 mb-6">Procedimento para retornar o equipamento 04B1 ao estado operacional normal ap√≥s conclus√£o dos trabalhos de manuten√ß√£o.</p><div class="text-center">${startNormalizationBtnHtml}</div></div></div>`; } }
      updateControlPanelButtons();
    }

    function startProcedure(){ stepStates[1]='ready'; liberationStarted=true; const startBtn=document.getElementById('startBtn'); if(startBtn){ startBtn.disabled=true; startBtn.textContent='‚úÖ MANOBRA INICIADA'; startBtn.className='px-8 py-4 bg-gradient-to-r from-green-600 to-green-700 text-white font-bold text-lg rounded-xl shadow-lg disabled:opacity-50 disabled:cursor-not-allowed'; } const skipBtn=document.getElementById('skipBtn'); const deferBtn=document.getElementById('deferBtn'); if(skipBtn) skipBtn.disabled=false; if(deferBtn) deferBtn.disabled=false; renderSteps(); updateControlButtonsState(); addToLog('üöÄ Procedimento de libera√ß√£o iniciado','info'); addToLog('Primeira etapa habilitada para execu√ß√£o','info'); }

    function startNormalization(){ stepStates[15]='ready'; normalizationStarted=true; const btn=document.getElementById('startNormalizationBtn'); if(btn){ btn.disabled=true; btn.textContent='‚úÖ NORMALIZA√á√ÉO INICIADA'; btn.className='px-8 py-4 bg-gradient-to-r from-blue-600 to-blue-700 text-white font-bold text-lg rounded-xl shadow-lg disabled:opacity-50 disabled:cursor-not-allowed'; } const skipBtn=document.getElementById('skipBtn'); const deferBtn=document.getElementById('deferBtn'); if(skipBtn) skipBtn.disabled=false; if(deferBtn) deferBtn.disabled=false; renderSteps(); updateControlButtonsState(); addToLog('üîì Procedimento de normaliza√ß√£o iniciado','info'); addToLog('Primeira etapa de normaliza√ß√£o habilitada para execu√ß√£o','info'); }

    function renderSteps(){ const grid=document.getElementById('stepsGrid'); grid.innerHTML=''; renderInfoHeader(); const shouldBlockNormalization=currentPage==='normalization'&&!normalizationAccessAuthorized; const filtered=steps.filter(s=> currentPage==='liberation'? s.phase==='LIBERA√á√ÉO': s.phase==='NORMALIZA√á√ÉO'); filtered.forEach(step=>{ const state=stepStates[step.id]; const isExecuting=state==='executing'; const isCompleted=state==='completed'; const isReady=state==='ready'; const isDisabled=state==='disabled'; const isSkipped=state==='skipped'; const isDeferred=state==='deferred'; const card=document.createElement('div'); card.className=`step-card bg-white rounded-xl shadow-lg border border-gray-200 p-6 ${isExecuting?'executing':''} ${(isSkipped||shouldBlockNormalization)?'opacity-60':''} ${isDeferred?'opacity-80':''}`; const executionTime=stepStates[`${step.id}_time`]; card.innerHTML = `<div class="flex items-start justify-between mb-4"><div class="flex items-center"><div class="step-number text-white font-bold text-sm px-3 py-1 rounded-full mr-3">${step.number}</div><div class="text-2xl mr-3">${step.icon}</div><div><span class="inline-block px-3 py-1 rounded-full text-xs font-medium text-white bg-gradient-to-r ${getResponsibleColor(step.responsible)}">${step.responsible}</span></div></div><div class="flex items-center space-x-2">${isCompleted&&executionTime?`<span class="text-xs font-semibold text-green-700 bg-green-100 px-2 py-1 rounded">${executionTime}</span>`:''}<div class="status-indicator w-4 h-4 rounded-full ${isCompleted?'completed':isExecuting?'executing-status':isSkipped?'skipped':isDeferred?'deferred':isReady?'pending':'disabled'}"></div></div></div><p class="text-gray-700 mb-6 text-lg leading-relaxed font-medium">${step.action}</p><button onclick="executeStep(${step.id})" ${( (!isReady && !isDeferred) || isExecuting || isSkipped || shouldBlockNormalization) ? 'disabled' : ''} class="execute-btn w-full py-3 px-4 rounded-lg font-semibold text-white transition-all duration-200 ${ shouldBlockNormalization?'bg-gray-400 cursor-not-allowed':isExecuting?'bg-amber-500 cursor-not-allowed':isCompleted?'bg-green-600':isSkipped?'bg-yellow-500 cursor-not-allowed':isDeferred?'bg-purple-600 hover:bg-purple-700':isReady?(currentPage==='liberation'?'bg-red-600 hover:bg-red-700':'bg-green-600 hover:bg-green-700'):'bg-gray-400 cursor-not-allowed' }">${ shouldBlockNormalization?'üö´ ACESSO RESTRITO': isExecuting?'‚è≥ EXECUTANDO...': isCompleted?'‚úÖ CONCLU√çDO': isSkipped?'‚è≠Ô∏è PULADO': isDeferred?'‚è∞ EXECUTAR ADIADO': isReady?'üöÄ EXECUTAR':'üîí BLOQUEADO' }</button>`; grid.appendChild(card); }); updateProgress(); }

    function togglePause(){ isPaused=!isPaused; const pauseBtn=document.getElementById('pauseBtn'); const overlay=document.getElementById('pauseOverlay'); const stepsGrid=document.getElementById('stepsGrid'); const nextBtn=document.getElementById('nextBtn'); const skipBtn=document.getElementById('skipBtn'); const deferBtn=document.getElementById('deferBtn'); if(isPaused){ pauseBtn.innerHTML='‚ñ∂Ô∏è Retomar'; pauseBtn.className='px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium transition-colors'; overlay.classList.add('active'); stepsGrid.classList.add('paused'); nextBtn.disabled=true; nextBtn.classList.add('opacity-50','cursor-not-allowed'); skipBtn.disabled=true; skipBtn.classList.add('opacity-50','cursor-not-allowed'); deferBtn.disabled=true; deferBtn.classList.add('opacity-50','cursor-not-allowed'); addToLog('‚è∏Ô∏è PROCEDIMENTO PAUSADO pelo operador','info'); addToLog('‚ö†Ô∏è Todos os controles bloqueados durante a pausa','info'); } else { pauseBtn.innerHTML='‚è∏Ô∏è Pausar'; pauseBtn.className='px-4 py-2 bg-orange-600 hover:bg-orange-700 text-white rounded-lg font-medium transition-colors'; overlay.classList.remove('active'); stepsGrid.classList.remove('paused'); nextBtn.disabled=false; nextBtn.classList.remove('opacity-50','cursor-not-allowed'); skipBtn.classList.remove('opacity-50','cursor-not-allowed'); deferBtn.classList.remove('opacity-50','cursor-not-allowed'); updateControlButtonsState(); addToLog('‚ñ∂Ô∏è PROCEDIMENTO RETOMADO pelo operador','success'); addToLog('‚úÖ Controles liberados para opera√ß√£o','success'); } }

    function executeStep(id){ const step=steps.find(s=>s.id===id); if(!step|| (stepStates[id]!=='ready' && stepStates[id]!=='deferred') || isPaused) return; if(id===8||id===9||id===26||id===27){ showMultiActionPopup(step); return; } if(step.action.includes('Abrir')||step.action.includes('Fechar')){ showCriticalActionConfirmation(step); return; } executeStepDirectly(id); }

    function showCriticalActionConfirmation(step){ const overlay=document.createElement('div'); overlay.className='fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50'; overlay.id='confirmationOverlay'; const popup=document.createElement('div'); popup.className='bg-white rounded-2xl shadow-2xl p-8 max-w-lg w-full mx-4 transform transition-all duration-300 scale-95'; popup.innerHTML=`<div class="text-center mb-6"><div class="text-6xl mb-4">‚ö†Ô∏è</div><h2 class="text-2xl font-bold text-red-600 mb-2">CONFIRMA√á√ÉO DE MANOBRA CR√çTICA</h2><p class="text-lg text-gray-600">Etapa ${step.number} - ${step.responsible}</p></div><div class="bg-yellow-50 border-2 border-yellow-300 rounded-xl p-6 mb-6"><h3 class="text-lg font-bold text-yellow-800 mb-3 flex items-center">üîß Confirma:</h3><p class="text-xl font-semibold text-yellow-900 leading-relaxed">${step.action}</p></div><div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-6"><p class="text-sm text-red-700 font-medium">‚ö†Ô∏è Esta √© uma manobra cr√≠tica que requer confirma√ß√£o do operador antes da execu√ß√£o.</p></div><div class="flex space-x-4"><button onclick="cancelCriticalAction()" class="flex-1 py-4 px-6 bg-gray-500 hover:bg-gray-600 text-white font-bold text-lg rounded-xl transition-all duration-200 transform hover:scale-105">‚ùå CANCELAR</button><button onclick="confirmCriticalAction(${step.id})" class="flex-1 py-4 px-6 bg-red-600 hover:bg-red-700 text-white font-bold text-lg rounded-xl transition-all duration-200 transform hover:scale-105">‚úÖ CONFIRMAR</button></div><div class="mt-4 text-center"><p class="text-xs text-gray-500">Certifique-se de que todas as condi√ß√µes de seguran√ßa foram verificadas</p></div>`; overlay.appendChild(popup); document.body.appendChild(overlay); setTimeout(()=>{ popup.style.transform='scale(1)'; },10); window.pendingCriticalStep=step; }

    async function confirmCriticalAction(stepId){ addToLog(`‚úÖ Manobra cr√≠tica confirmada pelo operador - Etapa ${window.pendingCriticalStep.number}`,'success'); closeCriticalActionPopup(); await executeStepDirectly(stepId); }
    function cancelCriticalAction(){ addToLog(`‚ùå Manobra cr√≠tica cancelada pelo operador - Etapa ${window.pendingCriticalStep.number}`,'info'); closeCriticalActionPopup(); }
    function closeCriticalActionPopup(){ const overlay=document.getElementById('confirmationOverlay'); if(overlay){ const popup=overlay.querySelector('div'); popup.style.transform='scale(0.8)'; popup.style.opacity='0'; setTimeout(()=>{ overlay.remove(); },200);} delete window.pendingCriticalStep; }

    async function executeStepDirectly(id){ const step=steps.find(s=>s.id===id); const wasDeferred=stepStates[id]==='deferred'; addToLog(`üîó Verificando comandos SSH para o item ${step.number}...`,'info'); const execResult=await execMappedCommands(step.number); if(execResult && execResult.executed && execResult.executed.length){ execResult.executed.forEach(r=>{ const ok=r.exit_status===0; addToLog(`${ok?'‚úÖ':'‚ùå'} SSH ${ok?'OK':'FALHA'}: ${r.command} ${r.stdout?' ‚Äî '+r.stdout:''} ${r.stderr?' ‚Äî '+r.stderr:''}`, ok?'success':'info'); }); if(!execResult.ok){ addToLog(`‚ö†Ô∏è Alguns comandos SSH falharam para ${step.number}. Verifique o equipamento.`, 'info'); } } else { addToLog(`‚ÑπÔ∏è Sem comandos mapeados para ${step.number}.`,'info'); }
      stepStates[id]='executing'; renderSteps(); setTimeout(()=>{ stepStates[id]='completed'; completedSteps++; const executionTime=new Date().toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'}); stepStates[`${id}_time`]=executionTime; if(!wasDeferred && id<steps.length){ stepStates[id+1]='ready'; currentStep=id+1; } renderSteps(); updateControlButtonsState(); addToLog(`‚úÖ Conclu√≠do ${step.number}: ${step.action}`,'success'); if(completedSteps===14){ addToLog('‚úÖ FASE DE LIBERA√á√ÉO CONCLU√çDA! Use "Pr√≥xima Etapa" para ir √† Normaliza√ß√£o.','success'); }
        if(completedSteps===steps.length){ addToLog('üéâ PROCEDIMENTO COMPLETO DE LIBERA√á√ÉO E NORMALIZA√á√ÉO 04B1 CONCLU√çDO COM SUCESSO!','success'); const nextBtn=document.getElementById('nextBtn'); const skipBtn=document.getElementById('skipBtn'); const deferBtn=document.getElementById('deferBtn'); if(nextBtn){ nextBtn.textContent='üéâ Conclu√≠do'; nextBtn.disabled=true; } if(skipBtn) skipBtn.disabled=true; if(deferBtn) deferBtn.disabled=true; }
        showSuccessAnimation(id);
      }, step.duration);
    }

    function showMultiActionPopup(step){ let actions=[]; if(step.id===8){ actions=[{name:'Fechar 34C3-2',icon:'üîß',duration:2000},{name:'Fechar 34W1-2',icon:'üîß',duration:2000}]; } else if(step.id===9){ actions=[{name:'Abrir 34W1-1',icon:'üîß',duration:2000},{name:'Abrir 34C3-1',icon:'üîß',duration:2000}]; } else if(step.id===26){ actions=[{name:'Fechar 34W1-1',icon:'üîß',duration:2000},{name:'Fechar 34C3-1',icon:'üîß',duration:2000}]; } else if(step.id===27){ actions=[{name:'Abrir 34C3-2',icon:'üîß',duration:2000},{name:'Abrir 34W1-2',icon:'üîß',duration:2000}]; }
      const overlay=document.createElement('div'); overlay.className='fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50'; overlay.id='multiActionOverlay'; const popup=document.createElement('div'); popup.className='bg-white rounded-2xl shadow-2xl p-8 max-w-2xl w-full mx-4 transform transition-all duration-300'; popup.innerHTML = `<div class="text-center mb-6"><h2 class="text-2xl font-bold text-gray-800 mb-2">‚ö° Execu√ß√£o de Manobras</h2><p class="text-lg text-gray-600">Etapa ${step.number}: ${step.responsible}</p><p class="text-sm text-gray-500 mt-2">Execute cada a√ß√£o separadamente e confirme individualmente</p></div><div class="space-y-4 mb-8" id="actionsList">${actions.map((a,i)=>`<div class=\"bg-gray-50 rounded-xl p-6 border border-gray-200\" id=\"action-${i}\"><div class=\"flex items-center justify-between mb-4\"><div class=\"flex items-center\"><span class=\"text-2xl mr-3\">${a.icon}</span><span class=\"text-lg font-semibold text-gray-800\">${a.name}</span></div><div class=\"flex items-center space-x-2\"><div class=\"w-3 h-3 bg-gray-400 rounded-full\" id=\"status-${i}\"></div><span class=\"text-xs text-gray-500\" id=\"time-${i}\"></span></div></div><button onclick=\"executeIndividualAction(${i}, '${a.name}', ${a.duration})\" id=\"btn-${i}\" class=\"w-full py-3 px-4 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg transition-all duration-200 transform hover:scale-105\">üöÄ Executar ${a.name}</button></div>`).join('')}<div class="text-center"><button onclick="closeMultiActionPopup()" class="mt-4 px-6 py-3 bg-gray-500 hover:bg-gray-600 text-white font-semibold rounded-lg transition-colors">‚ùå Cancelar</button><button onclick="completeMultiActionStep(${step.id})" id="completeBtn" disabled class="mt-4 px-6 py-3 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed">‚úÖ Concluir Etapa</button></div></div>`; overlay.appendChild(popup); document.body.appendChild(overlay); window.multiActionStates=actions.map(()=> 'pending'); window.currentMultiActionStep=step; setTimeout(()=>{ popup.style.transform='scale(1)'; },10); }

    async function executeIndividualAction(index, actionName, duration){ if(actionName.includes('Abrir')||actionName.includes('Fechar')){ showIndividualActionConfirmation(index, actionName, duration); return; } await executeIndividualActionDirectly(index, actionName, duration); }

    function showIndividualActionConfirmation(index, actionName, duration){ const overlay=document.createElement('div'); overlay.className='fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50'; overlay.id='individualConfirmationOverlay'; const popup=document.createElement('div'); popup.className='bg-white rounded-2xl shadow-2xl p-8 max-w-lg w-full mx-4 transform transition-all duration-300 scale-95'; popup.innerHTML=`<div class="text-center mb-6"><div class="text-6xl mb-4">‚ö†Ô∏è</div><h2 class="text-2xl font-bold text-red-600 mb-2">CONFIRMA√á√ÉO DE MANOBRA CR√çTICA</h2><p class="text-lg text-gray-600">Etapa ${window.currentMultiActionStep.number} - ${window.currentMultiActionStep.responsible}</p></div><div class="bg-yellow-50 border-2 border-yellow-300 rounded-xl p-6 mb-6"><h3 class="text-lg font-bold text-yellow-800 mb-3 flex items-center">üîß Confirma:</h3><p class="text-xl font-semibold text-yellow-900 leading-relaxed">${actionName}</p></div><div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-6"><p class="text-sm text-red-700 font-medium">‚ö†Ô∏è Esta √© uma manobra cr√≠tica que requer confirma√ß√£o do operador antes da execu√ß√£o.</p></div><div class="flex space-x-4"><button onclick="cancelIndividualAction()" class="flex-1 py-4 px-6 bg-gray-500 hover:bg-gray-600 text-white font-bold text-lg rounded-xl transition-all duration-200 transform hover:scale-105">‚ùå CANCELAR</button><button onclick="confirmIndividualAction(${index}, '${actionName}', ${duration})" class="flex-1 py-4 px-6 bg-red-600 hover:bg-red-700 text-white font-bold text-lg rounded-xl transition-all duration-200 transform hover:scale-105">‚úÖ CONFIRMAR</button></div><div class="mt-4 text-center"><p class="text-xs text-gray-500">Certifique-se de que todas as condi√ß√µes de seguran√ßa foram verificadas</p></div>`; overlay.appendChild(popup); document.body.appendChild(overlay); setTimeout(()=>{ popup.style.transform='scale(1)'; },10); }

    async function confirmIndividualAction(index, actionName, duration){ addToLog(`‚úÖ Manobra cr√≠tica confirmada pelo operador: ${actionName}`,'success'); closeIndividualActionPopup(); await executeIndividualActionDirectly(index, actionName, duration); }
    function cancelIndividualAction(){ addToLog(`‚ùå Manobra cr√≠tica cancelada pelo operador`,'info'); closeIndividualActionPopup(); }
    function closeIndividualActionPopup(){ const overlay=document.getElementById('individualConfirmationOverlay'); if(overlay){ const popup=overlay.querySelector('div'); popup.style.transform='scale(0.8)'; popup.style.opacity='0'; setTimeout(()=>{ overlay.remove(); },200);} }

    async function executeIndividualActionDirectly(index, actionName, duration){ const button=document.getElementById(`btn-${index}`); const status=document.getElementById(`status-${index}`); const timeSpan=document.getElementById(`time-${index}`); const step=window.currentMultiActionStep; addToLog(`üîó Executando comando SSH do item ${step.number} (a√ß√£o ${index+1})...`,'info'); const execResult=await execMappedCommands(step.number, index); if(execResult && execResult.executed && execResult.executed.length){ execResult.executed.forEach(r=>{ const ok=r.exit_status===0; addToLog(`${ok?'‚úÖ':'‚ùå'} SSH ${ok?'OK':'FALHA'}: ${r.command} ${r.stdout?' ‚Äî '+r.stdout:''} ${r.stderr?' ‚Äî '+r.stderr:''}`, ok?'success':'info'); }); if(!execResult.ok){ addToLog(`‚ö†Ô∏è Comando SSH falhou para ${step.number} (a√ß√£o ${index+1}).`,'info'); } } else { addToLog(`‚ÑπÔ∏è Sem comando mapeado para a a√ß√£o ${index+1} do item ${step.number}.`,'info'); }
      window.multiActionStates[index]='executing'; button.textContent='‚è≥ Executando...'; button.disabled=true; button.className='w-full py-3 px-4 bg-amber-500 text-white font-semibold rounded-lg cursor-not-allowed'; status.className='w-3 h-3 bg-amber-500 rounded-full'; setTimeout(()=>{ window.multiActionStates[index]='completed'; button.textContent='‚úÖ Conclu√≠do'; button.className='w-full py-3 px-4 bg-green-600 text-white font-semibold rounded-lg cursor-not-allowed'; status.className='w-3 h-3 bg-green-500 rounded-full'; const executionTime=new Date().toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'}); timeSpan.textContent=executionTime; timeSpan.className='text-xs font-semibold text-green-700 bg-green-100 px-2 py-1 rounded'; addToLog(`‚úÖ Conclu√≠do: ${actionName}`,'success'); const allCompleted=window.multiActionStates.every(s=> s==='completed'); if(allCompleted){ const completeBtn=document.getElementById('completeBtn'); completeBtn.disabled=false; completeBtn.className='px-6 py-3 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg transition-colors transform hover:scale-105'; completeBtn.style.animation='pulse 1.5s infinite'; } }, duration);
    }

    function completeMultiActionStep(stepId){ const step=window.currentMultiActionStep; stepStates[stepId]='completed'; completedSteps++; const executionTime=new Date().toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'}); stepStates[`${stepId}_time`]=executionTime; if(stepId<steps.length){ stepStates[stepId+1]='ready'; currentStep=stepId+1; } addToLog(`‚úÖ Etapa ${step.number} conclu√≠da com todas as manobras executadas`,'success'); if(completedSteps===14){ addToLog('‚úÖ FASE DE LIBERA√á√ÉO CONCLU√çDA! Use "Pr√≥xima Etapa" para ir √† Normaliza√ß√£o.','success'); }
      if(completedSteps===steps.length){ addToLog('üéâ PROCEDIMENTO COMPLETO DE LIBERA√á√ÉO E NORMALIZA√á√ÉO 04B1 CONCLU√çDO COM SUCESSO!','success'); const nextBtn=document.getElementById('nextBtn'); if(nextBtn){ nextBtn.textContent='üéâ Conclu√≠do'; nextBtn.disabled=true; } }
      closeMultiActionPopup(); renderSteps(); showSuccessAnimation(stepId); }

    function closeMultiActionPopup(){ const overlay=document.getElementById('multiActionOverlay'); if(overlay){ const popup=overlay.querySelector('div'); popup.style.transform='scale(0.8)'; popup.style.opacity='0'; setTimeout(()=>{ overlay.remove(); },200);} delete window.multiActionStates; delete window.currentMultiActionStep; }

    function skipCurrentStep(){ if(isPaused) return; const currentPageSteps=steps.filter(step=> currentPage==='liberation'? step.phase==='LIBERA√á√ÉO': step.phase==='NORMALIZA√á√ÉO'); const nextStep=currentPageSteps.find(step=> stepStates[step.id]==='ready'); if(nextStep){ showSkipConfirmation(nextStep); } }
    function deferCurrentStep(){ if(isPaused) return; const currentPageSteps=steps.filter(step=> currentPage==='liberation'? step.phase==='LIBERA√á√ÉO': step.phase==='NORMALIZA√á√ÉO'); const nextStep=currentPageSteps.find(step=> stepStates[step.id]==='ready'); if(nextStep){ showDeferConfirmation(nextStep); } }

    function showSkipConfirmation(step){ const overlay=document.createElement('div'); overlay.className='fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50'; overlay.id='skipConfirmationOverlay'; const popup=document.createElement('div'); popup.className='bg-white rounded-2xl shadow-2xl p-8 max-w-lg w-full mx-4 transform transition-all duration-300 scale-95'; popup.innerHTML=`<div class="text-center mb-6"><div class="text-6xl mb-4">‚ö†Ô∏è</div><h2 class="text-2xl font-bold text-yellow-600 mb-2">CONFIRMA√á√ÉO DE PULO</h2><p class="text-lg text-gray-600">Etapa ${step.number} - ${step.responsible}</p></div><div class="bg-yellow-50 border-2 border-yellow-300 rounded-xl p-6 mb-6"><h3 class="text-lg font-bold text-yellow-800 mb-3 flex items-center">‚è≠Ô∏è Pular Etapa:</h3><p class="text-xl font-semibold text-yellow-900 leading-relaxed">${step.action}</p></div><div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-6"><p class="text-sm text-red-700 font-medium">‚ö†Ô∏è ATEN√á√ÉO: Esta etapa ser√° marcada como PULADA e n√£o poder√° ser executada posteriormente. Esta a√ß√£o √© irrevers√≠vel.</p></div><div class="flex space-x-4"><button onclick="cancelSkip()" class="flex-1 py-4 px-6 bg-gray-500 hover:bg-gray-600 text-white font-bold text-lg rounded-xl transition-all duration-200 transform hover:scale-105">‚ùå CANCELAR</button><button onclick="confirmSkip(${step.id})" class="flex-1 py-4 px-6 bg-yellow-600 hover:bg-yellow-700 text-white font-bold text-lg rounded-xl transition-all duration-200 transform hover:scale-105">‚è≠Ô∏è CONFIRMAR PULO</button></div><div class="mt-4 text-center"><p class="text-xs text-gray-500">Certifique-se de que √© seguro pular esta etapa do procedimento</p></div>`; overlay.appendChild(popup); document.body.appendChild(overlay); setTimeout(()=>{ popup.style.transform='scale(1)'; },10); window.pendingSkipStep=step; }

    function showDeferConfirmation(step){ const overlay=document.createElement('div'); overlay.className='fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50'; overlay.id='deferConfirmationOverlay'; const popup=document.createElement('div'); popup.className='bg-white rounded-2xl shadow-2xl p-8 max-w-lg w-full mx-4 transform transition-all duration=300 scale=95'; popup.innerHTML=`<div class="text-center mb-6"><div class="text-6xl mb-4">‚è∞</div><h2 class="text-2xl font-bold text-purple-600 mb-2">CONFIRMA√á√ÉO DE ADIAMENTO</h2><p class="text-lg text-gray-600">Etapa ${step.number} - ${step.responsible}</p></div><div class="bg-purple-50 border-2 border-purple-300 rounded-xl p-6 mb-6"><h3 class="text-lg font-bold text-purple-800 mb-3 flex items-center">‚è∞ Adiar Etapa:</h3><p class="text-xl font-semibold text-purple-900 leading-relaxed">${step.action}</p></div><div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6"><p class="text-sm text-blue-700 font-medium">‚ÑπÔ∏è Esta etapa ser√° marcada como ADIADA e poder√° ser executada posteriormente a qualquer momento. O procedimento continuar√° com a pr√≥xima etapa.</p></div><div class="flex space-x-4"><button onclick="cancelDefer()" class="flex-1 py-4 px-6 bg-gray-500 hover:bg-gray-600 text-white font-bold text-lg rounded-xl transition-all duration-200 transform hover:scale-105">‚ùå CANCELAR</button><button onclick="confirmDefer(${step.id})" class="flex-1 py-4 px-6 bg-purple-600 hover:bg-purple-700 text-white font-bold text-lg rounded-xl transition-all duration-200 transform hover:scale-105">‚è∞ CONFIRMAR ADIAMENTO</button></div><div class="mt-4 text-center"><p class="text-xs text-gray-500">A etapa adiada ficar√° dispon√≠vel para execu√ß√£o posterior</p></div>`; overlay.appendChild(popup); document.body.appendChild(overlay); setTimeout(()=>{ popup.style.transform='scale(1)'; },10); window.pendingDeferStep=step; }

    function confirmSkip(stepId){ const step=window.pendingSkipStep; stepStates[stepId]='skipped'; const skipTime=new Date().toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'}); stepStates[`${stepId}_time`]=skipTime; if(stepId<steps.length){ stepStates[stepId+1]='ready'; currentStep=stepId+1; } addToLog(`‚è≠Ô∏è Etapa ${step.number} PULADA pelo operador: ${step.action}`,'info'); addToLog('‚ö†Ô∏è ATEN√á√ÉO: Etapa pulada n√£o pode ser executada posteriormente','info'); const currentPageSteps=steps.filter(s=> s.phase===step.phase); const completedOrSkipped=currentPageSteps.filter(s=> stepStates[s.id]==='completed'||stepStates[s.id]==='skipped').length; if(step.phase==='LIBERA√á√ÉO' && completedOrSkipped===14){ addToLog('‚úÖ FASE DE LIBERA√á√ÉO FINALIZADA! Use "Pr√≥xima Etapa" para ir √† Normaliza√ß√£o.','success'); } closeSkipPopup(); renderSteps(); updateSkipButtonState(); }

    function cancelSkip(){ addToLog('‚ùå Pulo cancelado pelo operador','info'); closeSkipPopup(); }
    function closeSkipPopup(){ const overlay=document.getElementById('skipConfirmationOverlay'); if(overlay){ const popup=overlay.querySelector('div'); popup.style.transform='scale(0.8)'; popup.style.opacity='0'; setTimeout(()=>{ overlay.remove(); },200);} delete window.pendingSkipStep; }

    function confirmDefer(stepId){ const step=window.pendingDeferStep; stepStates[stepId]='deferred'; const deferTime=new Date().toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'}); stepStates[`${stepId}_defer_time`]=deferTime; if(stepId<steps.length){ stepStates[stepId+1]='ready'; currentStep=stepId+1; } addToLog(`‚è∞ Etapa ${step.number} ADIADA pelo operador: ${step.action}`,'info'); addToLog('‚ÑπÔ∏è Etapa adiada pode ser executada posteriormente a qualquer momento','info'); closeDeferPopup(); renderSteps(); updateControlButtonsState(); }

    function cancelDefer(){ addToLog('‚ùå Adiamento cancelado pelo operador','info'); closeDeferPopup(); }
    function closeDeferPopup(){ const overlay=document.getElementById('deferConfirmationOverlay'); if(overlay){ const popup=overlay.querySelector('div'); popup.style.transform='scale(0.8)'; popup.style.opacity='0'; setTimeout(()=>{ overlay.remove(); },200);} delete window.pendingDeferStep; }

    function updateSkipButtonState(){ const skipBtn=document.getElementById('skipBtn'); if(!skipBtn) return; const currentPageSteps=steps.filter(step=> currentPage==='liberation'? step.phase==='LIBERA√á√ÉO': step.phase==='NORMALIZA√á√ÉO'); const hasReady=currentPageSteps.some(step=> stepStates[step.id]==='ready'); skipBtn.disabled= !(hasReady && !isPaused); }

    function updateControlPanelButtons(){ const resetBtn=document.querySelector('button[onclick="resetProcedure()"]'); const pauseBtn=document.getElementById('pauseBtn'); const skipBtn=document.getElementById('skipBtn'); const deferBtn=document.getElementById('deferBtn'); const nextBtn=document.getElementById('nextBtn'); const shouldBlockNormalization=currentPage==='normalization' && !normalizationAccessAuthorized; if(shouldBlockNormalization){ [resetBtn,pauseBtn,skipBtn,deferBtn,nextBtn].forEach(b=>{ if(!b) return; b.disabled=true; b.className='px-4 py-2 bg-gray-400 text-white rounded-lg font-medium cursor-not-allowed opacity-50'; }); } else { if(resetBtn){ resetBtn.disabled=false; resetBtn.className='px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg font-medium transition-colors'; } if(pauseBtn){ pauseBtn.disabled=false; pauseBtn.className = isPaused ? 'px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium transition-colors' : 'px-4 py-2 bg-orange-600 hover:bg-orange-700 text-white rounded-lg font-medium transition-colors'; } updateControlButtonsState(); } }

    function updateControlButtonsState(){ const skipBtn=document.getElementById('skipBtn'); const deferBtn=document.getElementById('deferBtn'); const finishBtn = document.getElementById('finishBtn'); if(!skipBtn||!deferBtn||!finishBtn) return; const shouldBlockNormalization=currentPage==='normalization' && !normalizationAccessAuthorized; if(shouldBlockNormalization) return; const procedureStarted=Object.values(stepStates).some(state=> ['ready','executing','completed','skipped','deferred'].includes(state)); const allFinished=steps.every(step=> stepStates[step.id]==='completed'|| stepStates[step.id]==='skipped'); if(procedureStarted && !allFinished){ skipBtn.disabled=false; skipBtn.className='px-4 py-2 bg-yellow-600 hover:bg-yellow-700 text-white rounded-lg font-medium transition-colors'; } else { skipBtn.disabled=true; skipBtn.className='px-4 py-2 bg-gray-400 text-white rounded-lg font-medium cursor-not-allowed opacity-50'; }
      if(procedureStarted && !isPaused && !allFinished){ deferBtn.disabled=false; deferBtn.className='px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg font-medium transition-colors'; } else { deferBtn.disabled=true; deferBtn.className='px-4 py-2 bg-gray-400 text-white rounded-lg font-medium cursor-not-allowed opacity-50'; }

      // Bot√£o CONCLUIR sempre habilitado
      finishBtn.disabled = false;
      finishBtn.className = 'px-4 py-2 bg-green-700 hover:bg-green-800 text-white rounded-lg font-medium transition-colors';
    }

    function executeNext(){ if(isPaused) return; if(currentPage==='liberation'){ const liberationSteps=steps.filter(s=> s.phase==='LIBERA√á√ÉO'); const incomplete=liberationSteps.filter(s=> stepStates[s.id]!=='completed' && stepStates[s.id]!=='skipped'); if(incomplete.length>0){ showPhaseTransitionConfirmation(incomplete); } else { normalizationAccessAuthorized=true; addToLog('üîì Acesso √† normaliza√ß√£o autorizado - Libera√ß√£o conclu√≠da','success'); switchPage('normalization'); addToLog('üîÑ Mudando para a p√°gina de Normaliza√ß√£o...','info'); } return; } return; }

    function showPhaseTransitionConfirmation(incomplete){ const overlay=document.createElement('div'); overlay.className='fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50'; overlay.id='phaseTransitionOverlay'; const popup=document.createElement('div'); popup.className='bg-white rounded-2xl shadow-2xl p-8 max-w-2xl w-full mx-4 transform transition-all duration-300 scale-95'; const executing=incomplete.filter(s=> stepStates[s.id]==='executing'); const ready=incomplete.filter(s=> stepStates[s.id]==='ready'); const deferred=incomplete.filter(s=> stepStates[s.id]==='deferred'); const disabled=incomplete.filter(s=> stepStates[s.id]==='disabled'); popup.innerHTML=`<div class="text-center mb-6"><div class="text-6xl mb-4">‚ö†Ô∏è</div><h2 class="text-2xl font-bold text-orange-600 mb-2">MANOBRAS DE LIBERA√á√ÉO INCOMPLETAS</h2><p class="text-lg text-gray-600">Deseja prosseguir para a Normaliza√ß√£o?</p></div><div class="bg-red-50 border-2 border-red-300 rounded-xl p-6 mb-6"><h3 class="text-lg font-bold text-red-800 mb-4 flex items-center">üö® SITUA√á√ÉO ATUAL DA LIBERA√á√ÉO:</h3><div class="space-y-3">${executing.length?`<div class=\"flex items-center justify-between bg-amber-100 p-3 rounded-lg\"><span class=\"font-semibold text-amber-800\">‚è≥ Etapas em Execu√ß√£o:</span><span class=\"font-bold text-amber-900\">${executing.length}</span></div>`:''}${ready.length?`<div class=\"flex items-center justify-between bg-blue-100 p-3 rounded-lg\"><span class=\"font-semibold text-blue-800\">üöÄ Etapas Prontas para Execu√ß√£o:</span><span class=\"font-bold text-blue-900\">${ready.length}</span></div>`:''}${deferred.length?`<div class=\"flex items-center justify-between bg-purple-100 p-3 rounded-lg\"><span class=\"font-semibold text-purple-800\">‚è∞ Etapas Adiadas:</span><span class=\"font-bold text-purple-900\">${deferred.length}</span></div>`:''}${disabled.length?`<div class=\"flex items-center justify-between bg-gray-100 p-3 rounded-lg\"><span class=\"font-semibold text-gray-800\">üîí Etapas Bloqueadas:</span><span class=\"font-bold text-gray-900\">${disabled.length}</span></div>`:''}</div></div><div class="bg-yellow-50 border border-yellow-300 rounded-lg p-4 mb-6"><p class="text-sm text-yellow-800 font-medium">‚ö†Ô∏è <strong>ATEN√á√ÉO:</strong> Prosseguir para a Normaliza√ß√£o sem concluir todas as etapas de Libera√ß√£o pode comprometer a seguran√ßa do procedimento. ${executing.length? 'H√° etapas ainda sendo executadas que continuar√£o em paralelo.':''}</p></div><div class="flex space-x-4"><button onclick="cancelPhaseTransition()" class="flex-1 py-4 px-6 bg-gray-500 hover:bg-gray-600 text-white font-bold text-lg rounded-xl transition-all duration-200 transform hover:scale-105">‚ùå PERMANECER NA LIBERA√á√ÉO</button><button onclick="confirmPhaseTransition()" class="flex-1 py-4 px-6 bg-orange-600 hover:bg-orange-700 text-white font-bold text-lg rounded-xl transition-all duration-200 transform hover:scale-105">‚ö†Ô∏è PROSSEGUIR PARA NORMALIZA√á√ÉO</button></div><div class="mt-4 text-center"><p class="text-xs text-gray-500">Recomenda-se concluir todas as etapas de libera√ß√£o antes de prosseguir</p></div>`; overlay.appendChild(popup); document.body.appendChild(overlay); setTimeout(()=>{ popup.style.transform='scale(1)'; },10); }

    function confirmPhaseTransition(){ addToLog('‚ö†Ô∏è OPERADOR PROSSEGUIU PARA NORMALIZA√á√ÉO COM LIBERA√á√ÉO INCOMPLETA','info'); addToLog('üîì Acesso √† normaliza√ß√£o autorizado via painel de controle','success'); normalizationAccessAuthorized=true; closePhaseTransitionPopup(); switchPage('normalization'); addToLog('üîÑ Mudando para a p√°gina de Normaliza√ß√£o...','info'); }
    function cancelPhaseTransition(){ addToLog('‚úÖ Operador optou por permanecer na fase de Libera√ß√£o','info'); closePhaseTransitionPopup(); }
    function closePhaseTransitionPopup(){ const overlay=document.getElementById('phaseTransitionOverlay'); if(overlay){ const popup=overlay.querySelector('div'); popup.style.transform='scale(0.8)'; popup.style.opacity='0'; setTimeout(()=>{ overlay.remove(); },200);} }

    function resetProcedure(){ showResetConfirmation(); }
    function showResetConfirmation(){ const overlay=document.createElement('div'); overlay.className='fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50'; overlay.id='resetConfirmationOverlay'; const popup=document.createElement('div'); popup.className='bg-white rounded-2xl shadow-2xl p-8 max-w-lg w-full mx-4 transform transition-all duration-300 scale-95'; popup.innerHTML=`<div class="text-center mb-6"><div class="text-6xl mb-4">‚ö†Ô∏è</div><h2 class="text-2xl font-bold text-red-600 mb-2">CONFIRMA√á√ÉO DE REINICIALIZA√á√ÉO</h2><p class="text-lg text-gray-600">Esta a√ß√£o n√£o pode ser desfeita</p></div><div class="bg-red-50 border-2 border-red-300 rounded-xl p-6 mb-6"><h3 class="text-lg font-bold text-red-800 mb-3 flex items-center">üîÑ O que ser√° reiniciado:</h3><ul class="text-sm text-red-700 space-y-2"><li>‚Ä¢ Todas as etapas voltar√£o ao estado inicial</li><li>‚Ä¢ Todo o progresso ser√° perdido</li><li>‚Ä¢ Log de execu√ß√£o ser√° limpo</li><li>‚Ä¢ Etapas conclu√≠das ser√£o desmarcadas</li><li>‚Ä¢ Etapas adiadas/puladas ser√£o resetadas</li></ul></div><div class="bg-yellow-50 border border-yellow-300 rounded-lg p-4 mb-6"><p class="text-sm text-yellow-800 font-medium">‚ö†Ô∏è <strong>ATEN√á√ÉO:</strong> Certifique-se de ter exportado o log se necess√°rio, pois todos os dados ser√£o perdidos permanentemente.</p></div><div class="flex space-x-4"><button onclick="cancelReset()" class="flex-1 py-4 px-6 bg-gray-500 hover:bg-gray-600 text-white font-bold text-lg rounded-xl transition-all duration-200 transform hover:scale-105">‚ùå CANCELAR</button><button onclick="confirmReset()" class="flex-1 py-4 px-6 bg-red-600 hover:bg-red-700 text-white font-bold text-lg rounded-xl transition-all duration-200 transform hover:scale-105">üîÑ CONFIRMAR REINICIALIZA√á√ÉO</button></div><div class="mt-4 text-center"><p class="text-xs text-gray-500">Esta a√ß√£o ir√° reiniciar completamente o procedimento</p></div>`; overlay.appendChild(popup); document.body.appendChild(overlay); setTimeout(()=>{ popup.style.transform='scale(1)'; },10); }

    function confirmReset(){ addToLog('üîÑ REINICIALIZA√á√ÉO CONFIRMADA pelo operador','info'); closeResetPopup(); executeReset(); }
    function cancelReset(){ addToLog('‚ùå Reinicializa√ß√£o cancelada pelo operador','info'); closeResetPopup(); }
    function closeResetPopup(){ const overlay=document.getElementById('resetConfirmationOverlay'); if(overlay){ const popup=overlay.querySelector('div'); popup.style.transform='scale(0.8)'; popup.style.opacity='0'; setTimeout(()=>{ overlay.remove(); },200);} }

    function executeReset(){ const wasInNormalization=currentPage==='normaliza√ß√£o'; steps.forEach(step=>{ stepStates[step.id]='disabled'; delete stepStates[`${step.id}_time`]; }); currentStep=1; completedSteps=0; normalizationAccessAuthorized=false; if(isPaused){ togglePause(); } if(wasInNormalization){ currentPage='normalization'; normalizationAccessAuthorized=false; } else { currentPage='liberation'; }
      const startBtn=document.getElementById('startBtn'); if(startBtn){ startBtn.disabled=false; startBtn.textContent='üöÄ INICIAR MANOBRA'; startBtn.className='px-8 py-4 bg-gradient-to-r from-red-600 to-red-700 hover:from-red-700 hover:to-red-800 text-white font-bold text-lg rounded-xl shadow-lg transform transition-all duration-200 hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none'; }
      const startNormalizationBtn=document.getElementById('startNormalizationBtn'); if(startNormalizationBtn){ startNormalizationBtn.disabled=false; startNormalizationBtn.textContent='üîì INICIAR NORMALIZA√á√ÉO'; startNormalizationBtn.className='px-8 py-4 bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 text-white font-bold text-lg rounded-xl shadow-lg transform transition-all duration-200 hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none'; }
      const log=document.getElementById('executionLog'); log.innerHTML='<p class="text-gray-500 italic">Procedimento reiniciado. Pronto para iniciar...</p>';
      const exportBtn=document.getElementById('exportBtn'); if(exportBtn) exportBtn.disabled=true;
      const nextBtn=document.getElementById('nextBtn'); nextBtn.textContent='‚ñ∂Ô∏è Pr√≥xima Etapa'; nextBtn.disabled=false; const skipBtn=document.getElementById('skipBtn'); const deferBtn=document.getElementById('deferBtn'); skipBtn.disabled=true; deferBtn.disabled=true; renderSteps(); updateControlButtonsState(); addToLog('üîÑ Procedimento reiniciado com sucesso','success'); addToLog('üîí Acesso √† normaliza√ß√£o resetado - Use "Pr√≥xima Etapa" no painel para acessar','info'); }

    function updateProgress(){ let currentPageSteps, currentPageCompleted; if(currentPage==='liberation'){ currentPageSteps=steps.filter(s=> s.phase==='LIBERA√á√ÉO'); currentPageCompleted=currentPageSteps.filter(s=> stepStates[s.id]==='completed').length; } else { currentPageSteps=steps.filter(s=> s.phase==='NORMALIZA√á√ÉO'); currentPageCompleted=currentPageSteps.filter(s=> stepStates[s.id]==='completed').length; } const progressPercent=(currentPageCompleted/currentPageSteps.length)*100; document.getElementById('progressBar').style.width=progressPercent+'%'; document.getElementById('progressText').textContent=`${currentPageCompleted}/${currentPageSteps.length}`; }

    function addToLog(message,type){ const log=document.getElementById('executionLog'); const timestamp=new Date().toLocaleTimeString('pt-BR'); if(log.children.length===1 && log.children[0].classList.contains('italic')){ log.innerHTML=''; const exportBtn=document.getElementById('exportBtn'); if(exportBtn) exportBtn.disabled=false; } const entry=document.createElement('div'); entry.className=`flex items-center justify-between p-3 rounded-lg ${ type==='success'?'bg-green-50 border border-green-200': type==='info'?'bg-blue-50 border border-blue-200':'bg-gray-50 border border-gray-200' }`; entry.innerHTML=`<span class="text-sm ${ type==='success'?'text-green-800': type==='info'?'text-blue-800':'text-gray-800' }">${message}</span><span class="text-xs text-gray-500">${timestamp}</span>`; log.insertBefore(entry, log.firstChild); }

    function exportLogToPDF(){ const log=document.getElementById('executionLog'); const entries=Array.from(log.children).reverse(); if(entries.length===0 || (entries.length===1 && entries[0].classList.contains('italic'))){ alert('N√£o h√° dados no log para exportar.'); return; } let pdf=`<!DOCTYPE html><html><head><meta charset=\"UTF-8\"><title>Log de Execu√ß√£o - Procedimento 04B1</title><style>body{font-family:Arial,sans-serif;margin:20px;line-height:1.6;color:#333}.header{text-align:center;border-bottom:2px solid #333;padding-bottom:20px;margin-bottom:30px}.header h1{color:#d32f2f;margin:0;font-size:24px}.header p{margin:5px 0;color:#666}.log-entry{margin:10px 0;padding:12px;border-left:4px solid #ddd;background:#f9f9f9}.log-entry.success{border-left-color:#4caf50;background:#f1f8e9}.log-entry.info{border-left-color:#2196f3;background:#e3f2fd}.timestamp{float:right;color:#888;font-size:12px}.message{font-weight:500}.footer{margin-top:40px;padding-top:20px;border-top:1px solid #ddd;text-align:center;color:#666;font-size:12px}.summary{background:#f5f5f5;padding:15px;border-radius:5px;margin:20px 0}.summary h3{margin-top:0;color:#333}</style></head><body><div class=\"header\"><h1>‚ö° LOG DE EXECU√á√ÉO - PROCEDIMENTO 04B1</h1><p><strong>Tipo:</strong> ${currentPage==='liberation'?'Libera√ß√£o':'Normaliza√ß√£o'} El√©trica</p><p><strong>Data de Gera√ß√£o:</strong> ${new Date().toLocaleDateString('pt-BR')} √†s ${new Date().toLocaleTimeString('pt-BR')}</p><p><strong>Equipamento:</strong> 04B1-CTM</p></div><div class=\"summary\"><h3>üìä Resumo da Execu√ß√£o</h3><p><strong>Total de Etapas Conclu√≠das:</strong> ${completedSteps}</p><p><strong>Fase Atual:</strong> ${currentPage==='liberation'?'Libera√ß√£o':'Normaliza√ß√£o'}</p><p><strong>Status:</strong> ${completedSteps===steps.length?'Procedimento Completo':'Em Andamento'}</p></div><h3>üìã Registro Cronol√≥gico de Atividades</h3>`; entries.forEach(entry=>{ if(entry.classList.contains('italic')) return; const msgEl=entry.querySelector('span:first-child'); const tsEl=entry.querySelector('span:last-child'); if(msgEl&&tsEl){ const msg=msgEl.textContent; const ts=tsEl.textContent; let cls='log-entry'; if(entry.classList.contains('bg-green-50')) cls+=' success'; else if(entry.classList.contains('bg-blue-50')) cls+=' info'; pdf += `<div class=\"${cls}\"><span class=\"timestamp\">${ts}</span><div class=\"message\">${msg}</div></div>`; } }); pdf += `<div class=\"footer\"><p><strong>RTM-CTM-04B1</strong> | Ed.: 2 | 28/09/2020</p><p>Elabora√ß√£o: Maria Amad√©lia Lopes</p><p>Documento gerado automaticamente pelo Sistema de Libera√ß√£o 04B1</p></div></body></html>`; const blob=new Blob([pdf],{type:'text/html'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); const currentDate=new Date().toISOString().slice(0,10); const currentTime=new Date().toTimeString().slice(0,5).replace(':',''); const filename=`Log_Procedimento_04B1_${currentPage}_${currentDate}_${currentTime}.html`; a.href=url; a.download=filename; a.style.display='none'; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); addToLog(`üìÑ Log exportado como: ${filename}`,'success'); }

    function showSuccessAnimation(id){ const cards=document.querySelectorAll('.step-card'); const stepIndex=steps.findIndex(s=> s.id===id); if(stepIndex!==-1 && cards[stepIndex]){ const card=cards[stepIndex]; card.style.transform='scale(1.02)'; card.style.boxShadow='0 0 20px rgba(34, 197, 94, 0.3)'; setTimeout(()=>{ card.style.transform=''; card.style.boxShadow=''; },500); } }

    // NOVO: finalizeProcedure sempre dispon√≠vel
    function finalizeProcedure(){ if(!confirm('ATEN√á√ÉO: Concluir ir√° bloquear a execu√ß√£o de novas etapas. Deseja continuar?')) return; addToLog('‚úîÔ∏è Procedimento marcado como conclu√≠do pelo operador','success'); // Desabilita apenas bot√µes de execu√ß√£o
      document.querySelectorAll('button').forEach(b=>{ if(['finishBtn','exportBtn'].includes(b.id)) return; b.disabled=true; b.classList.add('opacity-50','cursor-not-allowed'); }); const finishBtn=document.getElementById('finishBtn'); if(finishBtn){ finishBtn.textContent='‚úîÔ∏è CONCLU√çDO'; finishBtn.disabled=true; finishBtn.className='px-4 py-2 bg-green-800 text-white rounded-lg font-medium'; } }
    // Initialize
    renderSteps();
    addToLog('Sistema de libera√ß√£o e normaliza√ß√£o 04B1 inicializado','info');
    addToLog('Clique em "INICIAR MANOBRA" para come√ßar o procedimento...','info');
  </script>
 </body>
</html>